rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Role-Based Access Control
    // Fetches the user's profile to check if they have the 'admin' role.
    // Role-Based Access Control
    // Fetches the user's profile to check if they have the 'admin' role.
    function isAdmin() {
      let role = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return isAuthenticated() && (role == 'admin' || role == 'teacher' || role == 'super_admin');
    }

    // --- 1. User Data (Strict Ownership) ---
    // --- 1. User Data (Strict Ownership) ---
    match /users/{userId} {
      // Users can modify their own data. Admins can read all for dashboard/management.
      allow write: if isOwner(userId) || isAdmin();
      // Public Read (Authenticated) required for Leaderboards/Search
      allow read: if isAuthenticated();
      
      // --- Social Feature Subcollections ---
      
      // 1. Friend Requests: Allow other users to write (send) requests
      match /friend_requests/{requestId} {
        allow read: if isOwner(userId);
        // Security Fix: Validate that the 'sender' of the request is actually the authenticated user
        // This prevents User A from sending a request "from User B" to User C.
        allow write: if isAuthenticated() && (
          // If deleting (cancel/reject), must be owner of profile OR sender of request
          request.method == 'delete' || 
          // If creating/updating, data.uid must allow request.auth.uid (sender)
          request.resource.data.uid == request.auth.uid
        );
      }

      // 2. Friends: Allow mutual writing during acceptance
      match /friends/{friendId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated();
      }

      // 3. Game Invites: Allow others to drop an invite here
      match /game_invites/{inviteId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated();
      }

      // 4. Sent Game Invites: Allow the recipient to update status (accept/reject)
      match /sent_game_invites/{inviteId} {
        allow read: if isOwner(userId);
        allow write: if isAuthenticated();
      }

      // 5. Syllabus Tracker: Allow user to manage their progress
      match /syllabus_tracker/{docId} {
        allow read, write: if isOwner(userId);
      }

      // 6. Quiz Results (User History)
      match /quiz_results/{docId} {
        allow read, write: if isOwner(userId);
      }



      // 8. Completed Videos (Study Hub)
      match /completed_videos/{docId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Mind Games (Missing Rule Fix)
    match /mind_games/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 2. Admin Only Content (Protected) ---
    // Public Read, but Admin Write
    match /questions/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /notes/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /chapters/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /batches/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /metadata/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /live_quizzes/{quizId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participantsCount']));
      
      // Allow users to set reminders
      match /reminders/{userId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Study Hub (Video Resources)
    match /video_resources/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 3. Interactive Features (Authenticated Users) ---
    // These need to be writable by students for the app to function
    
    // Group Play (Rooms & Chat)
    match /rooms/{document=**} { 
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); 
    }
    
    // Results (Submissions)
    // Results (Submissions)
    match /results/{document=**} {
      allow read, write: if isAuthenticated();
    }

    match /live_quiz_results/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // Default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
