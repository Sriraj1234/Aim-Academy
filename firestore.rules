rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Role-Based Access Control
    // Fetches the user's profile to check if they have the 'admin' role.
    // Role-Based Access Control
    // Fetches the user's profile to check if they have the 'admin' role.
    function isAdmin() {
      let role = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return isAuthenticated() && (role == 'admin' || role == 'teacher' || role == 'super_admin');
    }

    // --- 1. User Data (Strict Ownership) ---
    // --- 1. User Data (Strict Ownership) ---
    match /users/{userId} {
      // Users can modify their own data. Admins can read all for dashboard/management.
      allow write: if isOwner(userId) || isAdmin();
      allow read: if isOwner(userId) || isAdmin();
    }

    // Mind Games (Missing Rule Fix)
    match /mind_games/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 2. Admin Only Content (Protected) ---
    // Public Read, but Admin Write
    match /questions/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /notes/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /chapters/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /batches/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /metadata/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /live_quizzes/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Study Hub (Video Resources)
    match /video_resources/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- 3. Interactive Features (Authenticated Users) ---
    // These need to be writable by students for the app to function
    
    // Group Play (Rooms & Chat)
    match /rooms/{document=**} { 
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); 
    }
    
    // Results (Submissions)
    match /results/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // Default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
